kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  # Mount the keys we will generate so the API server uses them
  extraMounts:
  - hostPath: ./sa-signer.key
    containerPath: /etc/kubernetes/pki/sa-signer.key
    readOnly: true
  - hostPath: ./sa-signer.pub
    containerPath: /etc/kubernetes/pki/sa-signer.pub
    readOnly: true
  # Patch the API server to use our custom issuer URL and keys
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        service-account-issuer: https://s3.${AWS_REGION}.amazonaws.com/${BUCKET_NAME}
        service-account-key-file: /etc/kubernetes/pki/sa-signer.pub
        service-account-signing-key-file: /etc/kubernetes/pki/sa-signer.key
  # Map ports for Istio Ingress Gateway
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP

# Worker nodes with Topology labels for Pod Affinity testing
- role: worker
  labels:
    topology.kubernetes.io/zone: us-east-1a
- role: worker
  labels:
    topology.kubernetes.io/zone: us-east-1b
- role: worker
  labels:
    topology.kubernetes.io/zone: us-east-1c
